[END_ALT-001]
disabled = 1
action.email.use_ssl = 0
action.webhook.enable_allowlist = 0
alert.expires = 15m
alert.suppress = 1
alert.suppress.period = 60m
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This monitors for suspicious Registry Modification via Direct Device Access"
dispatch.earliest_time = 0
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=attack_data  source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=13 Image="\\\\?\\*" earliest=0 latest=now\
| fields _time, source, sourcetype, host, Computer, TargetObject, registry_path,CommandLine EventCode, EventDescription,EventID, EventType, ClientInfo\
| eval alert_name="Suspicious Registry Modification via Direct Device Access"\
| eval suspicious_reason="Image path begins with \\\\?\\ (direct device access) - potential evasion technique"\
| eval event_time = _time \
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(_time, "%Y-%m-%d %H:%M:%S")\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=coalesce(Computer, host)\
| eval process_info=coalesce(Image, "N/A")\
| eval target_info=coalesce(TargetObject, registry_path, "N/A")\
| eval additional_context=suspicious_reason\
| table _time, alert_id, alert_name, event_time,severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source\
| collect index=notable

[END_ALT-002]
disabled = 1
search = index=attack_data sourcetype=XmlWinEventLog source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" process_name=*\
```the time range is only so I can search old data in the index```\
earliest=0 \
```Pull the fields of interest - improves search speed```\
| fields _time, source, sourcetype, process_name, Computer, CommandLine, User, Image\
```check lookup for blocked exec process - these would be blocked```\
| lookup iops_win_exec_process process_name OUTPUT status, category, risk_level, description\
```Check for blocked process or critical```\
| where status="blocked" OR risk_level="critical"\
```Add evals```\
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(_time, "%Y-%m-%d %H:%M:%S")\
| eval src_entity=coalesce(Computer, host)\
| eval process_info=Image\
| eval target_info=coalesce(CommandLine, "N/A")\
| eval event_time = _time\
```aggregate using stats```\
| stats \
    count as execution_count,\
    dc(Computer) as unique_hosts,\
    values(Computer) as affected_hosts,\
    values(User) as users,\
    values(CommandLine) as command_lines,\
    min(_time) as first_seen,\
    max(_time) as last_seen\
    by process_name, event_time, Image, risk_level, category\
| where execution_count > 0 \
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| eval alert_name="Blocked Process Execution Detected"\
```security alerts lookup```\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval suspicious_reason="Execution of blocked process:" \
| eval additional_context=suspicious_reason \
| eval src_entity=affected_hosts\
| eval process_info=Image\
| eval target_info=src_entity\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, execution_count, unique_hosts, risk_level\
| sort - execution_count\
| collect index=notable

[IAM_ALT-001]
disabled = 1 
action.webhook.enable_allowlist = 0
alert.expires = 30h
alert.suppress = 1
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */6 * * * *
description = Multiple Failed Logons
dispatch.earliest_time = 0
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data sourcetype="o365:management:activity" source=o365 command=UserLoginFailed LogonError=InvalidUserNameOrPassword\
earliest=0 latest=now\
```pull fields of interest speeds up search```\
| fields _time, host, source, sourcetype, ActorIpAddress, dvc, LogonError, CreationTime, ClientIP, command, src_ip, ResultDescription, ErrorDescription, LogonType, logon_type, ApplicationId, event_type, src_user, user, user_id\
| eval user=coalesce(src_user, user, user_id)\
| eval src_ip=coalesce(src_ip, ClientIP, dvc, ActorIpAddress)\
| eval logon_type=coalesce(LogonType, logon_type, ApplicationId, event_type, "Unknown")\
| eval failure_reason=coalesce(LogonError, ResultDescription, ErrorDescription, "Unknown")\
| eval event_time = _time\
| stats \
    count as failed_attempts,\
    dc(src_ip) as unique_source_ips,\
    values(src_ip) as source_ips,\
    values(logon_type) as logon_types,\
    values(failure_reason) as failure_reasons,\
    values(_time) as event_time\
    min(_time) as first_failure,\
    max(_time) as last_failure\
    by user,_time\
| where failed_attempts >= 3\
| eval alert_name="Multiple Failed Logons"\
| eval suspicious_reason="User account has " . failed_attempts . " failed login attempts in 5 minute window - potential brute force attack"\
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(first_failure, "%Y-%m-%d %H:%M:%S")\
| eval duration_minutes=round((last_failure - first_failure) / 60, 2)\
```Lookup alert```\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=user\
| eval process_info="N/A"\
| eval target_info=source_ips\
| eval additional_context=suspicious_reason . " | Unique IPs: " . unique_source_ips . " | Duration: " . duration_minutes . " mins | Reasons: " . failure_reasons\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, failed_attempts, unique_source_ips, logon_types\
| sort - failed_attempts\
| collect index=notable

[END_ALT-003]
action.webhook.enable_allowlist = 0
alert.expires = 60m
alert.suppress = 1
alert.suppress.period = 15m
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Unauthorised Privilege Escalation
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","sudo_user","dvc","COMMAND","USER","process","user_name","original_user"]
display.events.maxLines = 20
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=linux sourcetype=linux_secure source="/var/log/secure" (process="sudo" OR process="su") earliest=-10m latest=now \
| fields count, _time, _raw, source, sourcetype, action, app, dest, eventtype, host, process, user_name, dvc, priv_username\
    ```SUB search ```\
| join [search index=linux sourcetype=linux_secure source="/var/log/secure" "session opened for user root" earliest=-10m latest=now \
| rex field=_raw "session opened for user root\(uid=0\) by\s*(?<priv_username>\w+)\("\
    ] \
    ```lookup for unauthorised users```\
| lookup iops_linux_priv_users priv_username  OUTPUT priv_username, status, description,risk_level,role,team\
| where status="unauthorised"\
    ```aggreate stats ```\
| stats count AS execution_count, values(user_name), values(dest) AS dest, values(host) AS host , values(process) AS process values(priv_username) AS priv_username values(risk_level) as risk_level BY _time, user_name \
| rename values(user_name) AS root_user \
| where (process="su") \
| stats \
    count as execution_count,\
    dc(dest) as unique_hosts,\
    values(dest) as affected_hosts,\
    values(priv_username) as priv_username\
    values(risk_level) as risk_level\
    values(process) as process_info\
    values(dest) as source_ip\
    values(_time) as event_time\
    min(_time) as first_seen,\
    max(_time) as last_seen \
    by user_name, _time \
| where execution_count >= 0 \
| eval alert_name="Unauthorised Privilege Escalation" \
| eval suspicious_reason="User account has Logged in as root" \
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity \
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S") \
| eval alert_time=strftime(first_seen, "%Y-%m-%d %H:%M:%S") \
| eval duration_minutes=round((last_seen - first_seen) / 60, 2) \
| eval target_info=source_ip \
| eval src_entity=priv_username\
| eval additional_context=suspicious_reason \
    ```table the results``` \
| table alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, execution_count, unique_hosts, risk_level \
| sort - execution_count \
| sort - _time\
``` send data to notable```\
| collect index=notable

[NET_ALT-001]
action.webhook.enable_allowlist = 0
alert.expires = 1h
alert.suppress = 1
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = Exfiltration Over Web Service
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","sudo_user","dvc","COMMAND","USER","process","user_name","original_user","uri_path","uri_query","web_method","url","vocab_only","type","msg","general_name","site"]
display.events.maxLines = 20
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data \
sourcetype="nginx:plus:access" \
bytes_out=* \
```the time is so we can get test alerts normally set for 1 hour etc```\
earliest=-24h latest=now\
| eval GB_bytes_out=round(bytes_out/1024/1024/1024, 2)\
```this is to ensure any thing is over 100GB and a POST of data - meaning copied  - you can adjust for testing```\
| where (GB_bytes_out >= 0.1 AND http_method="POST")\
| bucket _time span=5m\
```Main aggregation```\
| stats \
    sum(GB_bytes_out) as total_gb_transferred,\
    count as request_count,\
    dc(uri_path) as unique_paths,\
    dc(dest_ip) as unique_destinations,\
    values(uri_path) as paths,\
    values(http_user_agent) as user_agents,\
    values(status) as http_statuses,\
    min(_time) as first_seen,\
    max(_time) as last_seen\
    max(time_local) as raw_local_time\
    by src, src_ip, dest_ip, http_method\
```If the threshold is over 0.1 100GB ```\
| where total_gb_transferred >= 0.1\
| eval alert_name="Exfiltration Over Web Service"\
| eval suspicious_reason="Large data upload detected: " . round(total_gb_transferred, 2) . " GB transferred via POST in " . request_count . " requests to " . unique_destinations . " destination(s)"\
| eval event_time = strftime(strptime(raw_local_time, "%d/%b/%Y:%H:%M:%S %z"), "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| eval duration_minutes=round((last_seen - first_seen) / 60, 2)\
```Lookup alert name and get fields  ```\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
```Normalise fields for incident and reporting dashboards```\
| eval src_entity=coalesce(src, src_ip, "Unknown")\
| eval process_info="HTTP POST: " . http_method\
| eval target_info=dest_ip \
| eval additional_context=suspicious_reason . " | Duration: " . duration_minutes . " mins | Paths: " . paths . " | User-Agents: " . user_agents . " | HTTP Status: " . http_statuses\
| table alert_time, event_time, alert_id, alert_name, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, total_gb_transferred, request_count, unique_destinations, duration_minutes\
| sort - total_gb_transferred\
| collect index=notable

[WEB_ALT-001]
action.webhook.enable_allowlist = 0
alert.expires = 60h
alert.suppress = 1
alert.suppress.period = 60h
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = SQL Injection Attack
dispatch.earliest_time = 0
display.events.fields = ["host","source","sourcetype","sudo_user","dvc","COMMAND","USER","process","user_name","original_user","uri_path","uri_query","web_method","url","vocab_only","type","msg","general_name","site","password","dest_ip","dest_port","file","page","id","user","username"]
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data  sourcetype="nginx:plus:access" earliest=-1h latest=now\
| fields host, sourcetype, source, _indextime,_raw,_time,eventtype,file,id,index\
```The time is just for testing change to 1 hour for prod```\
| rex field=_raw "^(?<src_ip>[^ ]+)\s+\-\s+\-\s+\[(?<timestamp>[^\]]+)\]\s+\"(?<http_method>[^ ]+)\s+(?<uri_path>[^ ]+)\s+(?<http_version>HTTP\/[\d\.]+)\"\s+(?<status>\d{3})\s+(?<bytes_out>[^ ]+)\s+\"(?<referer>[^\"]*)\"\s+\"(?<user_agent>[^\"]+)\""\
```search for pattens macros - macro = web_sql_pattern```\
| search `web_sql_patterns`\
```Detect SLQ patterns```\
 | eval sql_pattern = case(\
    match(uri_path, "(?i)UNION\\s+ALL\\s+SELECT"), "UNION ALL SELECT",\
    match(uri_path, "(?i)UNION\\s+SELECT"), "UNION SELECT",\
    match(uri_path, "(?i)SELECTCHAR\\s*\\("), "SELECTCHAR - obfuscated function",\
    match(uri_path, "(?i)%3Bdrop|;\\s*drop"), "DROP attempt",\
    match(uri_path, "(?i)exec\\b|%25exec%25"), "EXEC / stored proc exec",\
    match(uri_path, "(?i)--|%2D%2D"), "Comment-based SQLi",\
    1=1, "Unknown SQL pattern"\
)\
| bucket _time span=5m\
```Aggregate the data using stats```\
| stats \
    count as request_count,\
    dc(uri_path) as unique_paths,\
    dc(status) as unique_statuses,\
    values(uri_path) as paths,\
    values(status) as http_statuses,\
    values(http_method) as http_methods,\
    values(user_agent) as user_agents,\
    values(sql_pattern) as attack_patterns,\
    min(_time) as first_seen,\
    max(_time) as last_seen   \
    by src_ip, host\
```Tune here can be over 3 times to reduce noise```    \
| where request_count >= 1\
```Normalise and lookup for Secuerity App Dashboards Incidents```\
| eval alert_name="SQL Injection Attack"\
| eval suspicious_reason="SQL injection detected: " . request_count . " attempt(s) using pattern(s): " . attack_patterns\
| eval alert_time=strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| eval event_time=alert_time\
| eval duration_minutes=round((last_seen - first_seen) / 60, 2)\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=src_ip\
| eval process_info="HTTP " . http_methods . " request(s)"\
| eval target_info=host \
| eval additional_context=suspicious_reason . " | Duration: " . duration_minutes . " mins | HTTP Status: " . http_statuses . " | User-Agent: " . user_agents . " | Paths: " . paths\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, request_count, unique_paths, attack_patterns, duration_minutes, user_agents\
```Send to notable index```  \
| collect index=notable


[NET_ALT-002]
action.email.use_ssl = 0
action.webhook.enable_allowlist = 0
alert.expires = 1h
alert.suppress = 1
alert.suppress.period = 60h
alert.track = 1
counttype = number of events
cron_schedule = */7 * * * *
description = AWS Network Port Service Discovery Horiontal
disabled = 1
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","sudo_user","dvc","COMMAND","USER","process","user_name","original_user","uri_path","uri_query","web_method","url","vocab_only","type","msg","general_name","site","password","dest_ip","dest_port","file","page","id","user","username","user_agent","status"]
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data sourcetype="aws:cloudwatchlogs:vpcflow" source="aws:cloudwatchlogs:vpcflow:vertical.log" earliest=-1h@h latest=now\
\
```The below macro filter is for internal private ranges - commented out for testing```\
```| where `filter_private_src_ips```\
```scanning vertical logs one host for many ports```\
| fields _indextime,_raw,sourcetype,source,_time,account_id,action,vpcflow_action,app,aws_account_id,bytes,dest,dest_ip,dest_port,src_ip, src_port,duration,dvc,end_time,packets, interface_id, protocol vendor_product, transport\
``` interesting fields src_ip|action|dest,|dest_ip,|dest_port|aws_account_id```\
```10 minute window```\
| bucket _time span=10m\
```comment  Aggregate Data ```\
| stats \
   count as request_count,\
    dc(dest_port) as distinct_ports_scanned,\
    values(dest_port) as ports_scanned,\
    values(action) as actions,\
    values(aws_account_id) as aws_account_id,\
    min(_time) as first_seen,\
    max(_time) as last_seen\
    by _time, src_ip, dest_ip\
    ```Scanning for more ports than 20 - can be tweaked```\
| where distinct_ports_scanned > 20\
```comment  Alert Enrichment And  Normalization ```\
| eval alert_name="AWS Network Port Service Discovery Horiontal"\
| eval suspicious_reason = src_ip . " performed a network scan " . "Total Ports Scanned " . distinct_ports_scanned . " Account ID " . aws_account_id \
| eval alert_time = strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| eval event_time = strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
```comment Field Normalization for Dashboards ```\
| eval src_entity = src_ip\
| eval process_info = "Nmap Scanning|Script" \
| eval target_info = dest_ip\
| eval additional_context = suspicious_reason\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source,request_count\
| collect index=notable





[END_ALT-004]
action.webhook.enable_allowlist = 0
alert.expires = 1h
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */7 * * * *
description = Windows Suspicious Scheduled Task Creation
disabled = 1
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","sudo_user","dvc","COMMAND","USER","process","user_name","original_user","uri_path","uri_query","web_method","url","vocab_only","type","msg","general_name","site","password","dest_ip","dest_port","file","page","id","user","username","user_agent","status"]
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data sourcetype=XmlWinEventLog  source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventID=1 Image="*schtasks.exe"CommandLine="*/create*"\
earliest=0 latest=now\
| where (like(CommandLine, "%cmd.exe%") OR like(CommandLine, "%powershell%") OR like(CommandLine, "%onlogon%") OR like(CommandLine, "%onstart%") OR like(CommandLine, "%/ru system%") OR like(CommandLine, "%/S %"))\
| eval task_name=case(\
    match(CommandLine, "/tn\s+\"([^\"]+)\""), replace(CommandLine, "(?i).*\/tn\s+\"([^\"]+)\".*", "\1"),\
    match(CommandLine, "/tn\s+(\S+)"), replace(CommandLine, "(?i).*\/tn\s+(\S+).*", "\1"),\
    1=1, "Unknown"\
)\
```Lookup for any Windows Priv accounts ```\
| lookup iops_win_priv_acccounts account as User OUTPUT account_type\
| where isnull(account_type)\
| eval alert_name="Suspicious Scheduled Task Creation"\
| eval suspicious_reason="Scheduled task created via schtasks.exe with suspicious parameters (cmd/powershell execution, system privileges, or remote execution). Task Name: " + task_name\
| eval alert_time=strftime(_time, "%d-%m-%Y %H:%M:%S")\
| eval _time=strftime(_time, "%d-%m-%Y %H:%M:%S")\
| eval event_time=_time\
```Lookup alert details```\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=coalesce(Computer, host)\
| eval process_info=coalesce(ParentImage + " -> " + Image + " | " + CommandLine, "N/A")\
| eval target_info=coalesce("Task: " + task_name + " | User: " + User, "N/A")\
| eval additional_context=suspicious_reason\
| table _time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source\
| collect index=notable



