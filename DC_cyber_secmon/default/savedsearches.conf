[END_ALT-001]
action.email.use_ssl = 0
action.webhook.enable_allowlist = 0
alert.expires = 15m
alert.suppress = 1
alert.suppress.period = 60m
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This monitors for suspicious Registry Modification via Direct Device Access"
dispatch.earliest_time = 0
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=attack_data  source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=13 Image="\\\\?\\*" earliest=0 latest=now\
| fields _time, source, sourcetype, host, Computer, TargetObject, registry_path,CommandLine EventCode, EventDescription,EventID, EventType, ClientInfo\
| eval alert_name="Suspicious Registry Modification via Direct Device Access"\
| eval suspicious_reason="Image path begins with \\\\?\\ (direct device access) - potential evasion technique"\
| eval event_time = _time \
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(_time, "%Y-%m-%d %H:%M:%S")\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=coalesce(Computer, host)\
| eval process_info=coalesce(Image, "N/A")\
| eval target_info=coalesce(TargetObject, registry_path, "N/A")\
| eval additional_context=suspicious_reason\
| table _time, alert_id, alert_name, event_time,severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source\
| collect index=notable

[END_ALT-002]
action.webhook.enable_allowlist = 0
alert.expires = 30h
alert.suppress = 1
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = Blocked Process Execution Detectedl Failed
dispatch.earliest_time = 0
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data sourcetype=XmlWinEventLog source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" process_name=*\
earliest=0 \
```Pull the fields of interest - imporves searche speed```\
| fields _time, source, sourcetype, process_name, Computer, CommandLine, User, Image\
```check lookup for blocked exec process - these would be blocked```\
| lookup iops_win_exec_process process_name OUTPUT status, category, risk_level, description\
| where status="blocked" OR risk_level="critical"\
| eval alert_name="Blocked Process Execution Detected"\
```Add evals```\
| eval suspicious_reason="Execution of blocked process: " . process_name . " - " . description\
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(_time, "%Y-%m-%d %H:%M:%S")\
| eval src_entity=coalesce(Computer, host)\
| eval process_info=Image\
| eval target_info=coalesce(CommandLine, "N/A")\
| eval additional_context=suspicious_reason . " | Risk: " . risk_level . " | Category: " . category . " | User: " . coalesce(User, "Unknown")\
| eval event_time = _time\
```aggregate using stats```\
| stats \
    count as execution_count,\
    dc(Computer) as unique_hosts,\
    values(Computer) as affected_hosts,\
    values(User) as users,\
    values(CommandLine) as command_lines,\
    min(_time) as first_seen,\
    max(_time) as last_seen\
    by process_name, event_time, Image, risk_level, category\
| where execution_count > 0 \
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(first_seen, "%Y-%m-%d %H:%M:%S")\
| eval alert_name="Blocked Process Execution Detected"\
| eval suspicious_reason="Blocked process '" . process_name . "' executed " . execution_count . " times across " . unique_hosts . " host(s)"\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=affected_hosts\
| eval process_info=Image\
| eval target_info=command_lines\
| eval additional_context=suspicious_reason . " | Risk: " . risk_level . " | Users: " . users\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, execution_count, unique_hosts, risk_level\
| sort - execution_count\
| collect index=notable

[IAM_ALT-001]
action.webhook.enable_allowlist = 0
alert.expires = 30h
alert.suppress = 1
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */6 * * * *
description = Multiple Failed Logons
dispatch.earliest_time = 0
display.events.maxLines = 20
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DC_cyber_secmon
request.ui_dispatch_view = search
search = index=attack_data sourcetype="o365:management:activity" source=o365 command=UserLoginFailed LogonError=InvalidUserNameOrPassword\
earliest=0 latest=now\
```pull fields of interest speeds up search```\
| fields _time, host, source, sourcetype, ActorIpAddress, dvc, LogonError, CreationTime, ClientIP, command, src_ip, ResultDescription, ErrorDescription, LogonType, logon_type, ApplicationId, event_type, src_user, user, user_id\
| eval user=coalesce(src_user, user, user_id)\
| eval src_ip=coalesce(src_ip, ClientIP, dvc, ActorIpAddress)\
| eval logon_type=coalesce(LogonType, logon_type, ApplicationId, event_type, "Unknown")\
| eval failure_reason=coalesce(LogonError, ResultDescription, ErrorDescription, "Unknown")\
| eval event_time = _time\
| stats \
    count as failed_attempts,\
    dc(src_ip) as unique_source_ips,\
    values(src_ip) as source_ips,\
    values(logon_type) as logon_types,\
    values(failure_reason) as failure_reasons,\
    values(_time) as event_time\
    min(_time) as first_failure,\
    max(_time) as last_failure\
    by user,_time\
| where failed_attempts >= 3\
| eval alert_name="Multiple Failed Logons"\
| eval suspicious_reason="User account has " . failed_attempts . " failed login attempts in 5 minute window - potential brute force attack"\
| eval event_time=strftime(event_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_time=strftime(first_failure, "%Y-%m-%d %H:%M:%S")\
| eval duration_minutes=round((last_failure - first_failure) / 60, 2)\
```Lookup alert```\
| lookup iops_security_alerts_summary alert_name OUTPUT alert_id, data_source, mitre_tactic, mitre_technique_id, mitre_technique_name, severity\
| eval src_entity=user\
| eval process_info="N/A"\
| eval target_info=source_ips\
| eval additional_context=suspicious_reason . " | Unique IPs: " . unique_source_ips . " | Duration: " . duration_minutes . " mins | Reasons: " . failure_reasons\
| table alert_time, alert_id, alert_name, event_time, severity, src_entity, process_info, target_info, additional_context, mitre_technique_id, mitre_tactic, data_source, failed_attempts, unique_source_ips, logon_types\
| sort - failed_attempts\
| collect index=notable
